<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rage Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
            --neon-pink: #ff006e;
            --neon-cyan: #00f5ff;
            --neon-green: #39ff14;
            --neon-orange: #ff9500;
            --neon-purple: #bf00ff;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
        }

        .dark {
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: var(--text-primary);
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(45deg, transparent 48%, rgba(255, 0, 110, 0.03) 49%, rgba(255, 0, 110, 0.03) 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, rgba(0, 245, 255, 0.03) 49%, rgba(0, 245, 255, 0.03) 51%, transparent 52%);
            background-size: 60px 60px;
            animation: bgMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes bgMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(60px, 60px); }
        }

        .game-container {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 10px;
            width: 100%;
            max-width: 800px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 740px;
            padding: 0 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .title {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-cyan), var(--neon-green));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textGlow 3s ease-in-out infinite;
        }

        @keyframes textGlow {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 200% center; }
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .stat-icon {
            font-size: 1.2em;
        }

        .stat-value {
            font-weight: 700;
            color: var(--neon-cyan);
        }

        #canvas-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow:
                0 0 30px rgba(0, 245, 255, 0.3),
                0 0 60px rgba(255, 0, 110, 0.2),
                inset 0 0 100px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f23 100%);
        }

        .level-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.6rem, 2vw, 0.8rem);
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .controls-info {
            display: flex;
            gap: 15px;
            font-size: clamp(0.6rem, 1.5vw, 0.75rem);
            color: var(--text-secondary);
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-key {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .key {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
        }

        .credits {
            margin-top: 10px;
            text-align: center;
            font-size: clamp(0.5rem, 1.2vw, 0.65rem);
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .credits span {
            color: var(--neon-pink);
        }

        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            padding: 0 20px;
            justify-content: center;
            z-index: 100;
        }

        .control-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(57, 255, 20, 0.2);
            border: 3px solid var(--neon-green);
            color: var(--neon-green);
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            touch-action: manipulation;
            user-select: none;
            transition: all 0.1s;
            font-family: 'Press Start 2P', cursive;
        }

        .control-btn:active, .control-btn.pressed {
            background: rgba(57, 255, 20, 0.5);
            transform: scale(0.95);
            box-shadow: 0 0 30px var(--neon-green);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }

            .controls-info {
                display: none;
            }

            .game-container {
                padding-bottom: 160px;
            }
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            border-radius: 15px;
        }

        .overlay.hidden {
            display: none;
        }

        .overlay-title {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .overlay-text {
            font-size: clamp(0.7rem, 2vw, 1rem);
            color: var(--text-secondary);
            margin-bottom: 30px;
            text-align: center;
            padding: 0 20px;
            line-height: 1.8;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            font-size: clamp(0.55rem, 1.5vw, 0.7rem);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .start-btn {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            padding: 15px 40px;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            border: none;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(255, 0, 110, 0.7);
        }

        .win-stats {
            margin-top: 20px;
            font-size: clamp(0.8rem, 2vw, 1rem);
            color: var(--neon-green);
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <div class="game-container">
        <div class="header">
            <h1 class="title">RAGE GAME</h1>
            <div class="stats">
                <div class="stat">
                    <span class="stat-icon">‚è±Ô∏è</span>
                    <span class="stat-value" id="timer">0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üíÄ</span>
                    <span class="stat-value" id="deaths">0</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">ü™ô</span>
                    <span class="stat-value" id="coins">0</span>
                </div>
            </div>
        </div>

        <div id="canvas-wrapper">
            <canvas id="gameCanvas" width="720" height="400"></canvas>
            <div class="level-indicator" id="levelIndicator">LEVEL 1</div>

            <div class="overlay" id="startOverlay">
                <div class="overlay-title">RAGE GAME</div>
                <div class="overlay-text">
                    Hold SPACE to fly up!<br>
                    Bounce off walls to change direction!
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #1a5a9e;"></div>
                        <span>Dark Blue = Fall Down</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #66ccff;"></div>
                        <span>Light Blue = Safe</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ff006e;"></div>
                        <span>Pink = Bouncy</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #111; border: 2px solid #333;"></div>
                        <span>Black Ball = Game Over!</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: linear-gradient(135deg, #39ff14, #00ff88);"></div>
                        <span>Green = Exit</span>
                    </div>
                </div>
                <button class="start-btn" id="startBtn">START GAME</button>
            </div>

            <div class="overlay hidden" id="winOverlay">
                <div class="overlay-title">üéâ YOU WIN! üéâ</div>
                <div class="win-stats" id="winStats"></div>
                <button class="start-btn" id="restartBtn">PLAY AGAIN</button>
            </div>

            <div class="overlay hidden" id="gameOverOverlay">
                <div class="overlay-title" style="background: linear-gradient(90deg, #ff0000, #ff006e); -webkit-background-clip: text; background-clip: text;">üíÄ GAME OVER üíÄ</div>
                <div class="overlay-text">You hit the black ball!<br>Starting over from Level 1...</div>
                <div class="win-stats" id="gameOverStats"></div>
                <button class="start-btn" id="retryBtn">TRY AGAIN</button>
            </div>
        </div>

        <div class="controls-info">
            <div class="control-key"><span class="key">SPACE</span> Hold to fly up</div>
            <div class="control-key"><span class="key">R</span> Restart Level</div>
        </div>

        <div class="credits">
            ¬© Gameplay by <span>Oscar</span> ‚Ä¢ Web version by <span>Gaspard</span> 2026
        </div>
    </div>

    <div class="mobile-controls">
        <button class="control-btn" id="flyBtn">FLY</button>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Game state
        let gameRunning = false;
        let currentLevel = 1;
        let deaths = 0;
        let coins = 0;
        let timer = 0;
        let timerInterval = null;
        let deathFlash = 0;
        let levelFlash = 0;

        // Player
        const player = {
            x: 50,
            y: 200,
            width: 22,
            height: 22,
            vx: 3, // Horizontal velocity (direction)
            vy: 0,
            color: '#00f5ff'
        };

        // Physics
        const GRAVITY = 0.5;
        const FLY_FORCE = -0.9;
        const MAX_FALL_SPEED = 8;
        const MAX_FLY_SPEED = -7;
        const BOUNCE_FORCE = -15;
        const MOVE_SPEED = 3;

        // Input
        let flyPressed = false;

        // Level definitions with correct mechanics
        const levels = {
            1: {
                spawn: { x: 50, y: 200, vx: 3 },
                platforms: [
                    // Floor and ceiling
                    { x: 0, y: 370, w: 720, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    // Walls to bounce off
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 250, type: 'wall' },
                    // Platforms
                    { x: 150, y: 280, w: 100, h: 15, type: 'block' },
                    { x: 350, y: 180, w: 100, h: 15, type: 'block' },
                    { x: 500, y: 120, w: 80, h: 15, type: 'safe' },
                    // Exit
                    { x: 650, y: 270, w: 55, h: 100, type: 'exit' }
                ],
                hazards: [
                    { x: 250, y: 350, w: 80, h: 20, type: 'spike' },
                    { x: 450, y: 350, w: 80, h: 20, type: 'spike' }
                ],
                coins: [
                    { x: 200, y: 240, collected: false },
                    { x: 400, y: 140, collected: false }
                ]
            },
            2: {
                spawn: { x: 50, y: 200, vx: 3 },
                platforms: [
                    { x: 0, y: 370, w: 720, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 270, type: 'wall' },
                    // Dark blue pads (send down)
                    { x: 200, y: 150, w: 80, h: 15, type: 'darkblue' },
                    { x: 400, y: 200, w: 80, h: 15, type: 'darkblue' },
                    // Safe platforms
                    { x: 100, y: 280, w: 80, h: 15, type: 'safe' },
                    { x: 300, y: 300, w: 80, h: 15, type: 'safe' },
                    { x: 550, y: 250, w: 80, h: 15, type: 'bouncy' },
                    // Exit
                    { x: 650, y: 290, w: 55, h: 80, type: 'exit' }
                ],
                hazards: [
                    { x: 180, y: 350, w: 100, h: 20, type: 'spike' },
                    { x: 380, y: 350, w: 100, h: 20, type: 'spike' }
                ],
                coins: [
                    { x: 240, y: 110, collected: false },
                    { x: 440, y: 160, collected: false }
                ]
            },
            3: {
                spawn: { x: 50, y: 200, vx: 3 },
                platforms: [
                    { x: 0, y: 370, w: 720, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 350, type: 'wall' },
                    // Mixed platforms
                    { x: 100, y: 280, w: 60, h: 15, type: 'safe' },
                    { x: 200, y: 200, w: 60, h: 15, type: 'darkblue' },
                    { x: 300, y: 280, w: 60, h: 15, type: 'bouncy' },
                    { x: 400, y: 150, w: 60, h: 15, type: 'safe' },
                    { x: 500, y: 220, w: 60, h: 15, type: 'darkblue' },
                    { x: 600, y: 300, w: 60, h: 15, type: 'safe' },
                    // Exit at top
                    { x: 330, y: 50, w: 60, h: 40, type: 'exit' }
                ],
                hazards: [
                    { x: 150, y: 350, w: 60, h: 20, type: 'spike' },
                    { x: 350, y: 350, w: 60, h: 20, type: 'spike' },
                    { x: 550, y: 350, w: 60, h: 20, type: 'spike' }
                ],
                blackBalls: [
                    { x: 360, y: 200, r: 18, vx: 2, vy: 1.5 }
                ],
                coins: [
                    { x: 430, y: 110, collected: false },
                    { x: 630, y: 260, collected: false }
                ]
            },
            4: {
                spawn: { x: 50, y: 300, vx: 3 },
                platforms: [
                    { x: 0, y: 370, w: 720, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 350, type: 'wall' },
                    // Vertical maze
                    { x: 150, y: 100, w: 15, h: 200, type: 'wall' },
                    { x: 300, y: 170, w: 15, h: 200, type: 'wall' },
                    { x: 450, y: 100, w: 15, h: 200, type: 'wall' },
                    { x: 600, y: 170, w: 15, h: 130, type: 'wall' },
                    // Platforms
                    { x: 50, y: 250, w: 80, h: 15, type: 'safe' },
                    { x: 200, y: 150, w: 80, h: 15, type: 'bouncy' },
                    { x: 350, y: 280, w: 80, h: 15, type: 'darkblue' },
                    { x: 500, y: 180, w: 80, h: 15, type: 'safe' },
                    // Exit
                    { x: 640, y: 300, w: 50, h: 70, type: 'exit' }
                ],
                hazards: [
                    { x: 100, y: 350, w: 50, h: 20, type: 'spike' },
                    { x: 250, y: 350, w: 50, h: 20, type: 'spike' },
                    { x: 400, y: 350, w: 50, h: 20, type: 'spike' },
                    { x: 550, y: 350, w: 50, h: 20, type: 'spike' }
                ],
                blackBalls: [
                    { x: 230, y: 250, r: 15, vx: 0, vy: 2 }
                ],
                coins: [
                    { x: 240, y: 110, collected: false },
                    { x: 540, y: 140, collected: false }
                ]
            },
            5: {
                spawn: { x: 360, y: 300, vx: 3 },
                platforms: [
                    { x: 0, y: 370, w: 250, h: 30, type: 'floor' },
                    { x: 470, y: 370, w: 250, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 350, type: 'wall' },
                    // Center safe platform
                    { x: 300, y: 350, w: 120, h: 20, type: 'safe' },
                    // Floating platforms
                    { x: 150, y: 250, w: 80, h: 15, type: 'bouncy' },
                    { x: 490, y: 250, w: 80, h: 15, type: 'bouncy' },
                    { x: 320, y: 150, w: 80, h: 15, type: 'safe' },
                    // Exit at top
                    { x: 330, y: 40, w: 60, h: 50, type: 'exit' }
                ],
                hazards: [
                    { x: 250, y: 380, w: 50, h: 20, type: 'spike' },
                    { x: 420, y: 380, w: 50, h: 20, type: 'spike' }
                ],
                blackBalls: [
                    { x: 100, y: 150, r: 20, vx: 2.5, vy: 2 },
                    { x: 600, y: 200, r: 20, vx: -2, vy: 2.5 }
                ],
                coins: [
                    { x: 360, y: 110, collected: false }
                ]
            },
            6: {
                spawn: { x: 50, y: 300, vx: 3 },
                platforms: [
                    { x: 0, y: 370, w: 720, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 350, type: 'wall' },
                    // Complex layout
                    { x: 100, y: 280, w: 60, h: 15, type: 'darkblue' },
                    { x: 200, y: 200, w: 60, h: 15, type: 'safe' },
                    { x: 300, y: 120, w: 60, h: 15, type: 'bouncy' },
                    { x: 400, y: 200, w: 60, h: 15, type: 'darkblue' },
                    { x: 500, y: 280, w: 60, h: 15, type: 'safe' },
                    { x: 600, y: 180, w: 60, h: 15, type: 'bouncy' },
                    // Exit
                    { x: 650, y: 80, w: 50, h: 80, type: 'exit' }
                ],
                hazards: [
                    { x: 50, y: 350, w: 40, h: 20, type: 'spike' },
                    { x: 160, y: 350, w: 40, h: 20, type: 'spike' },
                    { x: 270, y: 350, w: 40, h: 20, type: 'spike' },
                    { x: 380, y: 350, w: 40, h: 20, type: 'spike' },
                    { x: 490, y: 350, w: 40, h: 20, type: 'spike' },
                    { x: 600, y: 350, w: 40, h: 20, type: 'spike' }
                ],
                blackBalls: [
                    { x: 350, y: 280, r: 18, vx: 2, vy: 0 },
                    { x: 200, y: 100, r: 15, vx: 0, vy: 2 }
                ],
                coins: [
                    { x: 330, y: 80, collected: false },
                    { x: 530, y: 240, collected: false },
                    { x: 630, y: 140, collected: false }
                ]
            },
            7: {
                spawn: { x: 50, y: 200, vx: 3 },
                platforms: [
                    { x: 0, y: 370, w: 720, h: 30, type: 'floor' },
                    { x: 0, y: 0, w: 720, h: 20, type: 'floor' },
                    { x: 0, y: 20, w: 15, h: 350, type: 'wall' },
                    { x: 705, y: 20, w: 15, h: 350, type: 'wall' },
                    // Final challenge
                    { x: 80, y: 280, w: 50, h: 15, type: 'safe' },
                    { x: 180, y: 180, w: 50, h: 15, type: 'bouncy' },
                    { x: 280, y: 100, w: 50, h: 15, type: 'darkblue' },
                    { x: 380, y: 180, w: 50, h: 15, type: 'safe' },
                    { x: 480, y: 280, w: 50, h: 15, type: 'bouncy' },
                    { x: 580, y: 150, w: 50, h: 15, type: 'safe' },
                    // Exit
                    { x: 650, y: 50, w: 50, h: 70, type: 'exit' }
                ],
                hazards: [
                    { x: 30, y: 350, w: 30, h: 20, type: 'spike' },
                    { x: 130, y: 350, w: 30, h: 20, type: 'spike' },
                    { x: 230, y: 350, w: 30, h: 20, type: 'spike' },
                    { x: 330, y: 350, w: 30, h: 20, type: 'spike' },
                    { x: 430, y: 350, w: 30, h: 20, type: 'spike' },
                    { x: 530, y: 350, w: 30, h: 20, type: 'spike' },
                    { x: 630, y: 350, w: 30, h: 20, type: 'spike' }
                ],
                blackBalls: [
                    { x: 200, y: 300, r: 20, vx: 2.5, vy: 1.5 },
                    { x: 500, y: 100, r: 20, vx: -2, vy: 2 },
                    { x: 350, y: 200, r: 15, vx: 1.5, vy: -2.5 }
                ],
                coins: [
                    { x: 305, y: 60, collected: false },
                    { x: 610, y: 110, collected: false }
                ]
            }
        };

        let levelData = null;

        function loadLevel(levelNum) {
            currentLevel = levelNum;
            levelData = JSON.parse(JSON.stringify(levels[levelNum]));

            // Initialize black balls
            if (levelData.blackBalls) {
                levelData.blackBalls.forEach(ball => {
                    ball.startX = ball.x;
                    ball.startY = ball.y;
                });
            }

            player.x = levelData.spawn.x;
            player.y = levelData.spawn.y;
            player.vx = levelData.spawn.vx || MOVE_SPEED;
            player.vy = 0;

            document.getElementById('levelIndicator').textContent = `LEVEL ${levelNum}`;
        }

        function resetLevel() {
            deaths++;
            document.getElementById('deaths').textContent = deaths;
            player.x = levelData.spawn.x;
            player.y = levelData.spawn.y;
            player.vx = levelData.spawn.vx || MOVE_SPEED;
            player.vy = 0;
            deathFlash = 15;

            // Reset black balls
            if (levelData.blackBalls) {
                levelData.blackBalls.forEach(ball => {
                    ball.x = ball.startX;
                    ball.y = ball.startY;
                });
            }
        }

        function gameOver() {
            gameRunning = false;
            clearInterval(timerInterval);

            const overlay = document.getElementById('gameOverOverlay');
            const stats = document.getElementById('gameOverStats');
            stats.innerHTML = `Reached Level: ${currentLevel}<br>Time: ${timer.toFixed(2)}s<br>Deaths: ${deaths}`;
            overlay.classList.remove('hidden');
        }

        function nextLevel() {
            if (currentLevel < 7) {
                levelFlash = 20;
                loadLevel(currentLevel + 1);
            } else {
                winGame();
            }
        }

        function winGame() {
            gameRunning = false;
            clearInterval(timerInterval);

            const winOverlay = document.getElementById('winOverlay');
            const winStats = document.getElementById('winStats');
            winStats.innerHTML = `Time: ${timer.toFixed(2)}s<br>Deaths: ${deaths}<br>Coins: ${coins}/13`;
            winOverlay.classList.remove('hidden');
        }

        function startGame() {
            document.getElementById('startOverlay').classList.add('hidden');
            document.getElementById('winOverlay').classList.add('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            deaths = 0;
            coins = 0;
            timer = 0;
            deathFlash = 0;
            levelFlash = 0;
            document.getElementById('deaths').textContent = '0';
            document.getElementById('coins').textContent = '0';
            document.getElementById('timer').textContent = '0.00';

            loadLevel(1);
            gameRunning = true;

            timerInterval = setInterval(() => {
                timer += 0.01;
                document.getElementById('timer').textContent = timer.toFixed(2);
            }, 10);
        }

        function update() {
            if (!gameRunning) return;

            // Apply fly force when space is held
            if (flyPressed) {
                player.vy += FLY_FORCE;
                if (player.vy < MAX_FLY_SPEED) player.vy = MAX_FLY_SPEED;
            }

            // Apply gravity
            player.vy += GRAVITY;
            if (player.vy > MAX_FALL_SPEED) player.vy = MAX_FALL_SPEED;

            // Update black balls
            if (levelData.blackBalls) {
                levelData.blackBalls.forEach(ball => {
                    ball.x += ball.vx;
                    ball.y += ball.vy;

                    // Bounce off walls
                    if (ball.x - ball.r < 15 || ball.x + ball.r > 705) ball.vx *= -1;
                    if (ball.y - ball.r < 20 || ball.y + ball.r > 370) ball.vy *= -1;

                    // Check collision with player
                    const dx = player.x + player.width / 2 - ball.x;
                    const dy = player.y + player.height / 2 - ball.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < ball.r + player.width / 2) {
                        gameOver(); // Black ball = restart entire game
                    }
                });
            }

            // Apply velocity
            player.x += player.vx;
            player.y += player.vy;

            // Platform collisions
            levelData.platforms.forEach(p => {
                if (p.type === 'exit') {
                    if (rectCollision(player, p)) {
                        nextLevel();
                        return;
                    }
                    return;
                }

                if (rectCollision(player, p)) {
                    const overlapX = Math.min(player.x + player.width - p.x, p.x + p.w - player.x);
                    const overlapY = Math.min(player.y + player.height - p.y, p.y + p.h - player.y);

                    if (overlapX < overlapY) {
                        // Horizontal collision - bounce off walls
                        if (player.x < p.x) {
                            player.x = p.x - player.width;
                        } else {
                            player.x = p.x + p.w;
                        }
                        player.vx *= -1; // Reverse horizontal direction
                    } else {
                        // Vertical collision
                        if (player.y < p.y) {
                            player.y = p.y - player.height;

                            // Handle different platform types
                            if (p.type === 'bouncy') {
                                player.vy = BOUNCE_FORCE;
                            } else if (p.type === 'darkblue') {
                                player.vy = 12; // Send player down fast
                            } else {
                                player.vy = 0;
                            }
                        } else {
                            player.y = p.y + p.h;
                            player.vy = Math.abs(player.vy) * 0.5; // Bounce down from ceiling
                        }
                    }
                }
            });

            // Hazard collisions
            levelData.hazards.forEach(h => {
                if (rectCollision(player, { x: h.x, y: h.y, width: h.w, height: h.h })) {
                    resetLevel();
                }
            });

            // Coin collisions
            if (levelData.coins) {
                levelData.coins.forEach(coin => {
                    if (!coin.collected) {
                        const dx = player.x + player.width / 2 - coin.x;
                        const dy = player.y + player.height / 2 - coin.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 20) {
                            coin.collected = true;
                            coins++;
                            document.getElementById('coins').textContent = coins;
                        }
                    }
                });
            }

            // Screen boundaries
            if (player.y < 20) {
                player.y = 20;
                player.vy = Math.abs(player.vy) * 0.5;
            }
            if (player.y + player.height > 370) {
                player.y = 370 - player.height;
                player.vy = 0;
            }
        }

        function rectCollision(a, b) {
            return a.x < b.x + (b.w || b.width) &&
                a.x + a.width > b.x &&
                a.y < b.y + (b.h || b.height) &&
                a.y + a.height > b.y;
        }

        function draw() {
            // Clear and draw background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a3e');
            gradient.addColorStop(1, '#0a0a1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 40) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            if (!levelData) return;

            // Draw platforms
            levelData.platforms.forEach(p => {
                ctx.save();

                switch (p.type) {
                    case 'floor':
                    case 'wall':
                        ctx.fillStyle = '#2a2a4a';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.strokeStyle = '#4a4a7a';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(p.x, p.y, p.w, p.h);
                        break;
                    case 'block':
                        ctx.fillStyle = '#3a3a5a';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.strokeStyle = '#5a5a8a';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(p.x, p.y, p.w, p.h);
                        break;
                    case 'bouncy':
                        ctx.fillStyle = '#ff006e';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.shadowColor = '#ff006e';
                        ctx.shadowBlur = 15;
                        ctx.strokeStyle = '#ff66a6';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(p.x, p.y, p.w, p.h);
                        break;
                    case 'safe':
                        ctx.fillStyle = '#66ccff';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.shadowColor = '#66ccff';
                        ctx.shadowBlur = 10;
                        ctx.strokeStyle = '#99ddff';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(p.x, p.y, p.w, p.h);
                        break;
                    case 'darkblue':
                        ctx.fillStyle = '#1a5a9e';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.shadowColor = '#1a5a9e';
                        ctx.shadowBlur = 10;
                        ctx.strokeStyle = '#2a7ace';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(p.x, p.y, p.w, p.h);
                        // Down arrow indicator
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 12px Orbitron';
                        ctx.textAlign = 'center';
                        ctx.fillText('‚Üì', p.x + p.w / 2, p.y + 12);
                        break;
                    case 'exit':
                        const exitGradient = ctx.createLinearGradient(p.x, p.y, p.x + p.w, p.y + p.h);
                        exitGradient.addColorStop(0, '#39ff14');
                        exitGradient.addColorStop(1, '#00ff88');
                        ctx.fillStyle = exitGradient;
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.shadowColor = '#39ff14';
                        ctx.shadowBlur = 25;
                        ctx.strokeStyle = '#99ff99';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(p.x, p.y, p.w, p.h);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 20px Orbitron';
                        ctx.textAlign = 'center';
                        ctx.fillText('‚Üí', p.x + p.w / 2, p.y + p.h / 2 + 7);
                        break;
                }
                ctx.restore();
            });

            // Draw hazards (spikes)
            levelData.hazards.forEach(h => {
                ctx.save();
                ctx.fillStyle = '#ff3333';
                ctx.shadowColor = '#ff0000';
                ctx.shadowBlur = 10;

                const spikeWidth = 15;
                const numSpikes = Math.floor(h.w / spikeWidth);
                for (let i = 0; i < numSpikes; i++) {
                    ctx.beginPath();
                    ctx.moveTo(h.x + i * spikeWidth, h.y + h.h);
                    ctx.lineTo(h.x + i * spikeWidth + spikeWidth / 2, h.y);
                    ctx.lineTo(h.x + (i + 1) * spikeWidth, h.y + h.h);
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.restore();
            });

            // Draw black balls
            if (levelData.blackBalls) {
                levelData.blackBalls.forEach(ball => {
                    ctx.save();
                    // Outer glow
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.r + 5, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(50, 50, 50, 0.5)';
                    ctx.fill();
                    // Main ball
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
                    ctx.fillStyle = '#111111';
                    ctx.shadowColor = '#000000';
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.strokeStyle = '#333333';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    // Skull icon
                    ctx.fillStyle = '#ff0000';
                    ctx.font = `${ball.r}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('‚ò†', ball.x, ball.y);
                    ctx.restore();
                });
            }

            // Draw coins
            if (levelData.coins) {
                levelData.coins.forEach(coin => {
                    if (!coin.collected) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(coin.x, coin.y, 12, 0, Math.PI * 2);
                        ctx.fillStyle = '#ffd700';
                        ctx.shadowColor = '#ffd700';
                        ctx.shadowBlur = 15;
                        ctx.fill();

                        ctx.beginPath();
                        ctx.arc(coin.x, coin.y, 7, 0, Math.PI * 2);
                        ctx.fillStyle = '#ffee88';
                        ctx.fill();
                        ctx.restore();
                    }
                });
            }

            // Draw player
            ctx.save();
            ctx.fillStyle = player.color;
            ctx.shadowColor = player.color;
            ctx.shadowBlur = 20;
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // Player glow
            ctx.strokeStyle = 'rgba(0, 245, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(player.x - 2, player.y - 2, player.width + 4, player.height + 4);

            // Direction indicator
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(player.vx > 0 ? '‚Üí' : '‚Üê', player.x + player.width / 2, player.y + player.height / 2 + 5);
            ctx.restore();

            // Death flash
            if (deathFlash > 0) {
                ctx.fillStyle = `rgba(255, 0, 0, ${deathFlash / 30})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                deathFlash--;
            }

            // Level complete flash
            if (levelFlash > 0) {
                ctx.fillStyle = `rgba(57, 255, 20, ${levelFlash / 40})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                levelFlash--;
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Keyboard events
        document.addEventListener('keydown', e => {
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', ' '].includes(e.key)) {
                e.preventDefault();
            }

            if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') {
                flyPressed = true;
            }

            if (e.key === 'r' || e.key === 'R') {
                if (gameRunning) resetLevel();
            }

            if ((e.key === 'Enter' || e.key === ' ') && !gameRunning) {
                startGame();
            }
        });

        document.addEventListener('keyup', e => {
            if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') {
                flyPressed = false;
            }
        });

        // Mobile controls
        const flyBtn = document.getElementById('flyBtn');

        flyBtn.addEventListener('touchstart', e => {
            e.preventDefault();
            flyPressed = true;
            flyBtn.classList.add('pressed');
        }, { passive: false });

        flyBtn.addEventListener('touchend', e => {
            e.preventDefault();
            flyPressed = false;
            flyBtn.classList.remove('pressed');
        }, { passive: false });

        flyBtn.addEventListener('mousedown', () => {
            flyPressed = true;
            flyBtn.classList.add('pressed');
        });

        flyBtn.addEventListener('mouseup', () => {
            flyPressed = false;
            flyBtn.classList.remove('pressed');
        });

        flyBtn.addEventListener('mouseleave', () => {
            flyPressed = false;
            flyBtn.classList.remove('pressed');
        });

        // Start/restart buttons
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', startGame);
        document.getElementById('retryBtn').addEventListener('click', startGame);

        // Resize canvas
        function resizeCanvas() {
            const maxWidth = Math.min(window.innerWidth - 40, 720);
            const scale = maxWidth / 720;
            canvas.style.width = maxWidth + 'px';
            canvas.style.height = 400 * scale + 'px';
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Initialize
        gameLoop();
    </script>
</body>
</html>
